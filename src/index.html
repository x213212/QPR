<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>目錄樹展示</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/themes/default/style.min.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f0f0f0;
        }
        h1 {
            text-align: center;
        }
        #controls {
            text-align: center;
            margin-bottom: 20px;
        }
        button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        #jstree {
            margin: 0 auto;
            width: 50%;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
        }
        #progress {
            margin-top: 20px;
            background-color: #fff;
            padding: 20px;
            border-radius: 5px;
        }
        ul {
            list-style-type: none;
            padding-left: 0;
        }
        li {
            margin: 5px 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jstree/3.3.12/jstree.min.js"></script>
</head>
<body>
    <h1>目錄樹展示</h1>
    <div id="controls">
        <button onclick="fetchTree()">顯示目錄樹</button>
        <button onclick="fetchProgress()">查看摘要進度</button>
    </div>
    <div id="jstree"></div>
    <div id="progress"></div>
    <script>
        function buildTreeData(directory) {
            const result = {
                text: directory.name,
                state: {
                    opened: true,
                },
                children: []
            };

            for (const subdir of directory.subdirs) {
                result.children.push(buildTreeData(subdir));
            }

            for (const file of directory.files) {
                const fileNode = {
                    text: file.name,
                    icon: "jstree-file",
                };
                if (file.summary) {
                    fileNode.a_attr = { "title": file.summary };
                }
                result.children.push(fileNode);
            }

            return result;
        }

        function fetchTree() {
            $.get('/filtered-tree', function(data) {
                const treeData = buildTreeData(data);
                $('#jstree').jstree('destroy');
                $('#jstree').jstree({
                    'core' : {
                        'data' : [treeData]
                    },
                    "plugins" : [ "wholerow", "tooltip" ]
                });
            });
        }

        function fetchProgress() {
            $.get('/progress', function(data) {
                displayProgress(data, $('#progress'));
            });
        }

        function displayProgress(progress, parentElement) {
            parentElement.empty();
            const progressText = `已完成 ${progress.completed_files} / ${progress.total_files} 個摘要`;
            const progressDiv = $('<div></div>').text(progressText);
            parentElement.append(progressDiv);

            const summariesUl = $('<ul></ul>');
            for (const [filePath, summary] of Object.entries(progress.summaries)) {
                const li = $('<li></li>').text(`${filePath}: ${summary}`);
                summariesUl.append(li);
            }
            parentElement.append(summariesUl);
        }
    </script>
</body>
</html>
